---
title: "Assignment 2: Spatial Analysis and Visualization"
subtitle: "Healthcare Access and Equity in Pennsylvania"
author: "Sihan Yu"
date: today
format: 
  html:
    code-fold: false
    toc: true
    toc-location: left
    theme: cosmo
    embed-resources: true
execute:
  warning: false
  message: false
---

## Assignment Overview

**Learning Objectives:**
- Apply spatial operations to answer policy-relevant research questions
- Integrate census demographic data with spatial analysis
- Create publication-quality visualizations and maps
- Work with spatial data from multiple sources
- Communicate findings effectively for policy audiences

---

## Part 1: Healthcare Access for Vulnerable Populations

### Research Question

**Which Pennsylvania counties have the highest proportion of vulnerable populations (elderly + low-income) living far from hospitals?**


#### Step 1: Data Collection (5 points)

Load the required spatial data:
- Pennsylvania county boundaries
- Pennsylvania hospitals (from lecture data)
- Pennsylvania census tracts

**Your Task:**
```{r}
# Load required packages

library(sf)
library(tidyverse)
library(tigris)
library(tidycensus)
library(scales)
library(patchwork)
library(here)

# Set Census API key
census_api_key("e173851c633e89c20243632174db68f63bac8856")

# Load spatial data

pa_counties <- st_read(here("assignments/assignments2/data/Pennsylvania_County_Boundaries.shp"))
hospitals <- st_read(here("assignments/assignments2/data/hospitals.geojson"))
census_tracts <- tracts(state = "PA", cb = TRUE,, progress_bar = FALSE)


# Standardize CRS
hospitals <- st_transform(hospitals, st_crs(pa_counties))
census_tracts <- st_transform(census_tracts, st_crs(pa_counties))

# check that all data loaded correctly

# Number of hospitals
n_hospitals <- nrow(hospitals)


# Number of census tracts
n_tracts <- nrow(census_tracts)

cat("Number of hospitals:", nrow(hospitals), "\n")
cat("Number of census tracts:", nrow(census_tracts), "\n")

cat("\nCoordinate Reference Systems (CRS):\n")
cat("Counties:", st_crs(pa_counties)$input, "\n")
cat("Hospitals:", st_crs(hospitals)$input, "\n")
cat("Census tracts:", st_crs(census_tracts)$input, "\n")


```

# Check that all data loaded correctly


**Questions to answer:**<br>
-  How many hospitals are in your dataset?<br>
   There are 223 hospitals in the dataset.<br>
-  How many census tracts?<br>
   There are 3445 census tracts.<br>
-  What coordinate reference system is each dataset in?<br>
   They share the same coordinate reference system: WGS 84.

---

#### Step 2: Get Demographic Data 

Use `tidycensus` to download tract-level demographic data for Pennsylvania.

**Required variables:**
- Total population
- Median household income
- Population 65 years and over (you may need to sum multiple age categories)

**Your Task:**



```{r}
# Get demographic data from ACS
#### Step 2: Get Demographic Data ----

pa_demo <- get_acs(
  geography = "tract",
  state = "PA",
  year = 2022,             
  survey = "acs5",
  variables = c(
    total_pop = "B01003_001",       # Total population
    median_income = "B19013_001",   # Median household income
    age_65_66 = "B01001_020",       # Male 65–66
    age_67_69 = "B01001_021",
    age_70_74 = "B01001_022",
    age_75_79 = "B01001_023",
    age_80_84 = "B01001_024",
    age_85_plus = "B01001_025",
    f_65_66 = "B01001_044",         # Female 65–66
    f_67_69 = "B01001_045",
    f_70_74 = "B01001_046",
    f_75_79 = "B01001_047",
    f_80_84 = "B01001_048",
    f_85_plus = "B01001_049"
  ),
  output = "wide"
)


pa_demo <- pa_demo %>%
  mutate(
    pop_65_over = age_65_66E + age_67_69E + age_70_74E + age_75_79E +
                  age_80_84E + age_85_plusE +
                  f_65_66E + f_67_69E + f_70_74E + f_75_79E +
                  f_80_84E + f_85_plusE
  ) %>%
  select(GEOID, total_pop = total_popE, median_income = median_incomeE, pop_65_over)



# Join to tract boundaries
census_tracts_demo <- census_tracts %>%
  left_join(pa_demo, by = "GEOID")


# 1. What year of ACS data are you using?
acs_year <- 2022
cat("ACS Year Used:", acs_year, "\n")

# 2. How many tracts have missing income data?
missing_income <- sum(is.na(census_tracts_demo$median_income))
cat("Number of tracts with missing income data:", missing_income, "\n")

# 3. What is the median income across all PA census tracts?
median_income_pa <- median(census_tracts_demo$median_income, na.rm = TRUE)
cat("Median income across all PA census tracts:", dollar(median_income_pa), "\n")



```


**Questions to answer:**<br>
-  What year of ACS data are you using?<br>
   I used data of 2022.<br>
-  How many tracts have missing income data?<br>
   There are 62 tracts missing.<br>
-  What is the median income across all PA census tracts?<br>
   The medium income across all PA census tracts is $70,188. 
---

#### Step 3: Define Vulnerable Populations 

Identify census tracts with vulnerable populations based on TWO criteria:
1. Low median household income (choose an appropriate threshold)
2. Significant elderly population (choose an appropriate threshold)

**Your Task:**
```{r}
# Filter for vulnerable tracts based on your criteria
income_threshold <- quantile(census_tracts_demo$median_income, 0.25, na.rm = TRUE)
elderly_threshold <- quantile(
  (census_tracts_demo$pop_65_over / census_tracts_demo$total_pop), 
  0.75, 
  na.rm = TRUE
)

cat("Low-income threshold:", scales::dollar(income_threshold), "\n")
cat("High-elderly threshold (share of 65+):", scales::percent(elderly_threshold), "\n")

census_tracts_demo <- census_tracts_demo %>%
  mutate(
    elderly_share = pop_65_over / total_pop
  )

vulnerable_tracts <- census_tracts_demo %>%
  filter(
    median_income <= income_threshold &
    elderly_share >= elderly_threshold
  )
cat("Number of vulnerable tracts identified:", nrow(vulnerable_tracts), "\n")

total_tracts <- nrow(census_tracts_demo)
vulnerable_count <- nrow(vulnerable_tracts)
vulnerable_pct <- (vulnerable_count / total_tracts) * 100
cat("Percentage of PA census tracts considered vulnerable:", round(vulnerable_pct, 1), "%\n")

```

**Questions to answer:**<br>
-  What income threshold did you choose and why?<br>
   I used $55,923.50 has the income threshold. It is based on the percentiles of the general income data and this is the benchmarks of the bottom 25% of the income across Pennsylvania counties.<br>
-  What elderly population threshold did you choose and why?<br>
   I used the same method as for the income threshold. I used the top 25% elderly share(23%) as my threshold. <br>
-  How many tracts meet your vulnerability criteria?<br>
   There are 165 tracts meet my vulnerability criteria.<br>
-  What percentage of PA census tracts are considered vulnerable by your definition?<br>
   There are 4.8% of PA census tracts that are vulnerable.
---

#### Step 4: Calculate Distance to Hospitals 

For each vulnerable tract, calculate the distance to the nearest hospital.

**Your Task:**
```{r}
# Transform to appropriate projected CRS
library(units)
vulnerable_tracts_proj <- st_transform(vulnerable_tracts, 5070)
hospitals_proj <- st_transform(hospitals, 5070)

tract_centroids <- st_centroid(vulnerable_tracts_proj)
# Calculate distance from each tract centroid to nearest hospital
dist_matrix <- st_distance(tract_centroids, hospitals_proj)
nearest_hospital_dist_m <- apply(dist_matrix, 1, min)

nearest_hospital_dist_miles <- as.numeric(nearest_hospital_dist_m)/1609.34

vulnerable_tracts_proj <- vulnerable_tracts_proj %>%
  mutate(distance_to_hospital_miles = nearest_hospital_dist_miles)

avg_distance <- mean(vulnerable_tracts_proj$distance_to_hospital_miles, na.rm = TRUE)
max_distance <- max(vulnerable_tracts_proj$distance_to_hospital_miles, na.rm = TRUE)
num_over_15 <- sum(vulnerable_tracts_proj$distance_to_hospital_miles > 15, na.rm = TRUE)

cat(
  "Average distance to nearest hospital (miles):", round(avg_distance, 2), "\n",
  "Maximum distance to nearest hospital (miles):", round(max_distance, 2), "\n",
  "Number of vulnerable tracts >15 miles from hospital:", num_over_15, "\n"
)


```

**Requirements:**
- Use an appropriate projected coordinate system for Pennsylvania
- Calculate distances in miles
- Explain why you chose your projection

**Questions to answer:**<br>
-  What is the average distance to the nearest hospital for vulnerable tracts?<br>
   The average distance is 4.75 miles.<br>
-  What is the maximum distance?<br>
   The maximum distance is 19.16 miles.<br>
-  How many vulnerable tracts are more than 15 miles from the nearest hospital?<br>
   There are 9 tracts are more than 15 miles from the nearest hospital.
---

#### Step 5: Identify Underserved Areas 

Define "underserved" as vulnerable tracts that are more than 15 miles from the nearest hospital.

**Your Task:**
```{r}
# Create underserved variable

vulnerable_tracts_proj <- vulnerable_tracts_proj %>%
  mutate(underserved = distance_to_hospital_miles > 15)

num_underserved <- sum(vulnerable_tracts_proj$underserved, na.rm = TRUE)

# Percentage of vulnerable tracts that are underserved
perc_underserved <- num_underserved / nrow(vulnerable_tracts_proj) * 100

cat("Number of underserved tracts:", num_underserved, "\n")
cat("Percentage of vulnerable tracts underserved:", round(perc_underserved, 2), "%\n")




```

**Questions to answer:**<br>
-  How many tracts are underserved?<br>
   There are 9 tracts are underserved.<br>
-  What percentage of vulnerable tracts are underserved?<br>
   There are 5.45% of the vulnerable tracts are underserved.<br>
-  Does this surprise you? Why or why not?<br>
   It doesn't surprise me. It shows that the hospitals are relatively well_distributed in Pennsylvania that only a small amount of vulnerable tracts are more than 15 miles from the nearest hospital. The few underserved tract are likely in rural areas, however, most of the population concentrated in urban and suburban counties.
---

#### Step 6: Aggregate to County Level

Use spatial joins and aggregation to calculate county-level statistics about vulnerable populations and hospital access.

**Your Task:**
```{r}
# Spatial join tracts to counties

pa_counties_proj <- st_transform(pa_counties, 5070)

tract_centroids <- st_centroid(vulnerable_tracts_proj)
tract_centroids <- cbind(tract_centroids, vulnerable_tracts_proj)
tracts_with_county <- st_join(tract_centroids, pa_counties_proj, join = st_within)

# Aggregate statistics by county
county_stats <- tracts_with_county %>%
  group_by(COUNTY_NAM) %>%          
  summarise(
    n_vulnerable_tracts = n(),
    n_underserved = sum(distance_to_hospital_miles > 15, na.rm = TRUE),
    pct_underserved = n_underserved / n_vulnerable_tracts * 100,
    avg_distance_miles = mean(distance_to_hospital_miles, na.rm = TRUE),
    total_vulnerable_pop = sum(total_pop, na.rm = TRUE)
  ) %>%
  arrange(desc(pct_underserved))

st_drop_geometry(county_stats)


```



**Required county-level statistics:**
- Number of vulnerable tracts
- Number of underserved tracts  
- Percentage of vulnerable tracts that are underserved
- Average distance to nearest hospital for vulnerable tracts
- Total vulnerable population

**Questions to answer:**<br>
-  Which 5 counties have the highest percentage of underserved vulnerable tracts?<br>
   The 5 counties are Bradford, Forest, Juniata, Monroe, Sullivan.They all have 1 tract that is vulnerable and undeserved.<br>
-  Which counties have the most vulnerable people living far from hospitals?<br>
   Allegheny County has the most vulnerable people ~51790 living far from hospitals.<br>
-  Are there any patterns in where underserved counties are located?<br>
   The underserved counties are located in northern and central rural Pennsyvania with relatively low population density.
---

#### Step 7: Create Summary Table 

Create a professional table showing the top 10 priority counties for healthcare investment.

**Your Task:**
```{r}
# Create and format priority counties table
library(knitr)
library(dplyr)
library(scales)

priority_counties <- county_stats %>%
  arrange(desc(pct_underserved)) %>%
  mutate(
    pct_underserved = round(pct_underserved, 1),
    avg_distance_miles = round(avg_distance_miles, 1),
    total_vulnerable_pop = comma(total_vulnerable_pop)
  ) %>%
  select(
    County = COUNTY_NAM,
    `Vulnerable Tracts` = n_vulnerable_tracts,
    `Underserved Tracts` = n_underserved,
    `Underserved (%)` = pct_underserved,
    `Avg Distance to Hospital (miles)` = avg_distance_miles,
    `Total Vulnerable Population` = total_vulnerable_pop
  ) 

priority_counties_top10 <- priority_counties %>% slice(1:10)

kable(
  st_drop_geometry(priority_counties),
  caption = "Table: Top 10 Priority Counties for Healthcare Investment in Pennsylvania",
  align = "lccccr",
  format = "pipe"
)


```

**Requirements:**
- Use `knitr::kable()` or similar for formatting
- Include descriptive column names
- Format numbers appropriately (commas for population, percentages, etc.)
- Add an informative caption
- Sort by priority (you decide the metric)

---

## Part 2: Comprehensive Visualization 

Using the skills from Week 3 (Data Visualization), create publication-quality maps and charts.

### Map 1: County-Level Choropleth 

Create a choropleth map showing healthcare access challenges at the county level.

**Your Task:**
```{r}
# Create county-level access map
library(ggplot2)
library(scales)
library(dplyr)


pa_counties_map <- pa_counties_proj %>%
  left_join(
    priority_counties %>%
      st_drop_geometry() %>% 
      select(County, `Underserved (%)`),
    by = c("COUNTY_NAM" = "County")
  )

ggplot() +
  geom_sf(
    data = pa_counties_map,
    aes(fill = `Underserved (%)`),
    color = "white", size = 0.25
  ) +
  geom_sf(
    data = hospitals,
    shape = 21, fill = "white", color = "black", size = 2, alpha = 0.8
  ) +
  scale_fill_viridis_c(
    option = "Viridis",
    name = "% Underserved (of vulnerable tracts)",
    labels = function(x) paste0(x, "%"),
    na.value = "grey90",
    limits = c(0, 100)
  ) +
  labs(
    title = "Healthcare Access Challenges in Pennsylvania",
    subtitle = "Percent of vulnerable census tracts that are underserved (>15 miles from nearest hospital)",
    caption = "Sources: ACS 2022 5-year (tidycensus), lecture hospital data, county boundaries"
  ) +
  theme_void() 
```


**Requirements:**
- Fill counties by percentage of vulnerable tracts that are underserved
- Include hospital locations as points
- Use an appropriate color scheme
- Include clear title, subtitle, and caption
- Use `theme_void()` or similar clean theme
- Add a legend with formatted labels

---

### Map 2: Detailed Vulnerability Map 

Create a map highlighting underserved vulnerable tracts.

**Your Task:**
```{r}
# Create detailed tract-level map
vulnerable_tracts_proj <- vulnerable_tracts_proj %>%
  mutate(
    vulnerable= median_income <= income_threshold &
                elderly_share >= elderly_threshold
  ) %>%
  mutate(
    tract_status = case_when(
      vulnerable & underserved ~ "Underserved & Vulnerable",
      vulnerable & !underserved ~ "Served & Vulnerable",
      TRUE ~ "Other Tracts"
  )
)

  
ggplot()+
  geom_sf(data = pa_counties_proj, fill = "grey50", color = "white", size = 0.3) +
  geom_sf(
    data = vulnerable_tracts_proj,
    aes(fill = tract_status),
    color = NA,
    alpha = 0.8
  ) +
  geom_sf(
     data = hospitals, shape = 21, fill = "white", color = "black", size = 2, alpha = 0.8
  ) +
  scale_fill_manual(
    name = "Tract Status",
    values = c(
      "Underserved & Vulnerable" = "#d7191c",
      "Served & Vulnerable" = "#fdae61",
      "Other Tracts" = "#cccccc" 
    )
  ) +
  labs(
    title = "Underserved Vulnerable Tracts in Pennsylvania",
    subtitle = "Tracts identified as both socially vulnerable and >15 miles from nearest hospital",
    caption = "Sources: ACS 2022 5-year (tidycensus), hospital data, county boundaries"
  ) +
  theme_void()
  


```

**Requirements:**
- Show underserved vulnerable tracts in a contrasting color
- Include county boundaries for context
- Show hospital locations
- Use appropriate visual hierarchy (what should stand out?)
- Include informative title and subtitle

---

### Chart: Distribution Analysis

Create a visualization showing the distribution of distances to hospitals for vulnerable populations.

**Your Task:**
```{r}
# Create distribution visualization
ggplot(vulnerable_tracts_proj, aes(x = distance_to_hospital_miles)) +
  geom_histogram(bins = 20, fill = "#4575b4", color = "white", alpha = 0.8) +
  geom_vline(xintercept = 15, color = "#d7191c", linetype = "dashed", size = 1) +
  labs(
    title = "Distribution of Distance to Nearest Hospital for Vulnerable Tracts",
    x = "Distance to Nearest Hospital (miles)",
    y = "Number of Vulnerable Tracts",
    caption = "Dashed line indicates 15-mile threshold for underserved classification"
  ) +
  theme_minimal(base_size = 12)


```

**Suggested chart types:**
- Histogram or density plot of distances
- Box plot comparing distances across regions
- Bar chart of underserved tracts by county
- Scatter plot of distance vs. vulnerable population size

**Requirements:**
- Clear axes labels with units
- Appropriate title
- Professional formatting
- Brief interpretation (1-2 sentences as a caption or in text)

---

## Part 3: Bring Your Own Data Analysis 


#### Environmental Justice

**Option C: Green Space Equity** 
- **Data:** Parks, Street Trees, Census tracts (race/income demographics)
- **Question:** "Do low-income and minority neighborhoods have equitable access to green space?"
- **Operations:** Buffer parks (10-minute walk = 0.5 mile), calculate tree canopy or park acreage per capita, compare by demographics
- **Policy relevance:** Climate resilience, environmental justice, urban forestry investment
---
**Your Task:**

1. **Find and load additional data**
   - Document your data source
   - Check and standardize the CRS
   - Provide basic summary statistics


```{r}
# Load your additional dataset
library(sf)
parks <- st_read("PPR_Program_Sites.geojson")
parks <- st_transform(parks, crs = 3857)  # Web Mercator


vars <- c(
  median_income = "B19013_001",
  total_pop = "B02001_001",
  white_pop = "B02001_002"
)

phl_tracts <- get_acs(
  geography = "tract",
  variables = vars,
  state = "PA",
  county = "Philadelphia",
  geometry = TRUE,   
  year = 2023
) %>%
  select(GEOID, NAME, variable, estimate, geometry) %>%
  tidyr::pivot_wider(names_from = variable, values_from = estimate) %>%
  mutate(
    minority_share = (total_pop - white_pop) / total_pop * 100
  )

head(phl_tracts)
summary(trees)
```


**Questions to answer:**<br>
- What dataset did you choose and why?<br>
  I chose the Philadelphia parks dataset because public parks represent accessible green space for residents. Analyzing their distribution helps assess equity in green space access across different neighborhoods.<br>
- What is the data source and date?<br>
  The dataset comes from OpenDataPhilly, specifically the “PPR Program Sites” dataset, most recently updated in 2023.<br>
- How many features does it contain?<br>
  The dataset contains 171 park features.<br>
- What CRS is it in? Did you need to transform it?<br>
  The parks dataset was originally in WGS84 (EPSG:4326). For consistency with other spatial layers and to facilitate distance and area calculations, I transformed it to EPSG:3857 (Web Mercator projection).
---

2. **Pose a research question**

Do low-income and minority neighborhoods in Philadelphia have equitable access to green spaces within a 10-minute walk distance?


---

3. **Conduct spatial analysis**

Use at least TWO spatial operations to answer your research question.

**Required operations (choose 2+):**
- Buffers
- Spatial joins
- Spatial filtering with predicates
- Distance calculations
- Intersections or unions
- Point-in-polygon aggregation

**Your Task:**
```{r}
# Your spatial analysis
# buffer a 0.5 mile distance from the park polygon ~10min
parks_buffer <- st_buffer(parks, dist = 800)
parks_buffer <- st_transform(parks_buffer, st_crs(phl_tracts))



#  Spatial join to identify tracts within 0.5 miles of any park 
census_access <- phl_tracts %>%
  mutate(has_access = lengths(st_intersects(geometry, parks_buffer)) > 0)

# Summary statistics 
access_summary <- census_access %>%
  group_by(income_group = case_when(
    median_income < median(median_income, na.rm = TRUE) ~ "Low Income",
    TRUE ~ "High Income"
  )) %>%
  summarise(
    total_tracts = n(),
    tracts_with_access = sum(has_access),
    pct_with_access = round(mean(has_access) * 100, 1)
  )

print(access_summary)

```




```{r}


ggplot() +
  geom_sf(data = census_access, aes(fill = median_income), color = "white", size = 0.1) +
  
  geom_sf(
    data = parks_buffer,
    fill = "#32CD32", alpha = 0.25, color = NA
  ) +
  
  geom_sf(
    data = parks,
    color = "#228B22", size = 1.2
  ) +

 scale_fill_gradientn(
  name = "Median Household Income ($)",
  colors = c("#4575b4", "#91bfdb", "#fdae61","orange", "#d73027")  # 蓝→浅蓝→浅橙→橙
  ) +
  
  labs(
    title = "Philadelphia Census Tracts by Income and Park Accessibility",
    subtitle = "Red shaded areas represent 500 m park buffer zones",
    caption = "Data: OpenDataPhilly Parks, ACS 2021"
  ) +
  
  theme_minimal() 



```




**Your interpretation:**

The table shows that park accessibility is 87.2% in high-income areas and slightly higher at 95.3% in low-income areas, indicating that not all high-income tracts are near parks, though there is a cluster of parks in moderate-income areas in South Philly. Maps show that parks and housing are more concentrated in the city center and low-income areas, while high-income areas in the northwest, northeast, and south are larger but have more dispersed parks. This likely reflects land use and planning: low-density neighborhoods with private yards leave fewer public parks. Overall, park distribution appears influenced more by urban layout and planning than by income alone.


## Finally - A few comments about your incorporation of feedback!
I really appreciated the detailed feedback on my first assignment. It suggested that I clean up unnecessary content and remove figures that didn’t need to be displayed. Following this advice, I tried to clean my Markdown document this time to try to make it look much cleaner and more professional. I hope to continue improving in this way with future assignments.


